---
title: "Symbiont-Thermal-Stress"
author: "Elsa Brenner, Nick Peoples, Erica Sun"
date: "4/6/2021"
output: html_document
---
## Getting started
Set your working directory
```{r}
setwd("/Users/ericasun/Documents/GitHub/Symbiont-Thermal-Stress/") #you will need to change to your own directory
```

Install the packages
```{r}
install.packages('VennDiagram')
```

Load the require libraries
```{r}
library(DESeq2) #Version 1.30.1
library(affycoretools) #Version 1.62.0
library(arrayQualityMetrics) #Version 3.46.0
library(genefilter) #Version 1.72.1
library(Biobase) #Version 2.50.0
library(ggplot2) #Version 3.3.3
library(dplyr) #Version 1.0.5
library(tidyverse) #Version 1.3.0
library(pheatmap) #Version 1.0.12
library(vegan) #Version 2.5.7
library(ggrepel) #Version 0.9.1
library(RColorBrewer) #Version 1.1.2
library(gplots) #Version 3.1.1
library(VennDiagram) #Version 1.6.20
```
Read in counts and assign it to countData
```{r}
countData <- read.table("B_psygmophilum_counts.txt")
head(countData)
length(countData[,1])
```
Here, we have 8 controls, 4 cool, and 8 heat samples. This is due to the cool samples having a lower cell count. 
```{r}
names(countData)=c( "Control_1.1", "Control_1", "Control_2.1", "Control_2", "Control_3.1", "Control_3", "Control_4.1", "Control_4", "Cool_1", "Cool_2", "Cool_3", "Cool_4","Heat_1.1", "Heat_1", "Heat_2.1", "Heat_2", "Heat_3.1", "Heat_3", "Heat_4.1", "Heat_4")
row.names(countData)=sub("", "isogroup", rownames(countData))
head(countData)
```
Make sure you can succesfully read in the iso2gene tab separated file
```{r}
gg=read.table("B_psygmophilum_sequenceID_to_isogroup.tab",sep="\t",quote="", row.names=1) 
```

## Conduct array quality metrics to detect and remove outliers
First we need to set the working directory and create a conditions table.
```{r}
#setwd("C:/Users/Corey/Downloads/Rscriptanddata/New_Oc9/Gene_Expression/outlier")
setwd("/Users/ericasun/Documents/GitHub/Symbiont-Thermal-Stress/Outliers/")
#v=setwd("C:/Users/Corey/Downloads/Rscriptanddata/New_Oc9/Gene_Expression/outlier")
v=setwd("/Users/ericasun/Documents/GitHub/Symbiont-Thermal-Stress/Outliers/")
treat=c( "Control_1.1", "Control_1", "Control_2.1", "Control_2", "Control_3.1", "Control_3", "Control_4.1", "Control_4", "Cool_1", "Cool_2", "Cool_3", "Cool_4","Heat_1.1", "Heat_1", "Heat_2.1", "Heat_2", "Heat_3.1", "Heat_3", "Heat_4.1", "Heat_4")
g=data.frame(treat)
g
colData= g
head(colData)
```
Here, we are using DESeq to create a model for us to see how our design is varied by treatment
```{r}
dds=DESeqDataSetFromMatrix(countData=countData,
                           colData = g,
                           design = ~treat)
```
Then we can normalize our data using vsd
```{r}
vsd.ge=assay(vst(dds))
rl=vst(dds)
e=ExpressionSet(assay(rl), AnnotatedDataFrame(as.data.frame(colData(rl))))
arrayQualityMetrics(e,outdir=v,intgroup=c("treat"),force=T)
warnings()
#dev.off() #for windows if there is a bug
```
Now we can go over to our Outliers directory and take a look at the index.html file. There is one outlier found in the Cool_1 sample. However,  when we look at the PCA plot, the Cool_1 data point is still grouped with the other data point, and not too far  away. Thus, we decided to not remove any data point.

Here marks the end of detecting outliers! Remember, you only have to run the code above once as outliers are decided at the beginning.

## Identifying differentially expressed genes using DESeq
Read in counts again, since we won't be repeating the outlier part. 
```{r}
ountData <- read.table("B_psygmophilum_counts.txt")
head(countData)
length(countData[,1])
#28265

names(countData)=c( "Control_1.1", "Control_1", "Control_2.1", "Control_2", "Control_3.1", "Control_3", "Control_4.1", "Control_4", "Cool_1", "Cool_2", "Cool_3", "Cool_4","Heat_1.1", "Heat_1", "Heat_2.1", "Heat_2", "Heat_3.1", "Heat_3", "Heat_4.1", "Heat_4")
row.names(countData)=sub("", "isogroup", rownames(countData))
head(countData)
```
Let's generate a table and visualize the total counts.
```{r}
totalCounts=colSums(countData)
totalCounts
barplot(totalCounts, col=c("green", "green", "green", "green", "green", "green", "green", "green", "blue", "blue", "blue", "blue", "red", "red", "red", "red", "red", "red", "red", "red"), ylab="raw counts", main="Total counts of each sample")
```
Figure 1. Total raw counts in each sample. The y-axis shows the total raw number of counts with the x-axis denoting the samples. Each sample group with a different experimental temperature are denoted by colors, where greem is the control, blue is cool, and red is heat. Control_1.1 has the highest raw counts of *B. psygmophilum* out of all 20 sample groups (n=1285858), and Cool_1 has the lowest raw count (n=484972).

Notes: Make the x-axis more clear, which bar belongs to which sample? Green = control, blue = cool etc. Make x-axis vertical?

```{r}
min(totalCounts) #484972
max(totalCounts)  #1285858
```


Create conditions table and deseq object. This is the same one as what we used for outliers.
```{r}
treat=c( "Control", "Control", "Control", "Control", "Control", "Control", "Control", "Control", "Cool", "Cool", "Cool", "Cool","Heat", "Heat", "Heat", "Heat", "Heat", "Heat", "Heat", "Heat")
g=data.frame(treat)
g
colData<- g
dds<-DESeqDataSetFromMatrix(countData=countData, colData=colData, design=~treat) #can only test for the main effects of site, pco2, temp
```

Run the one step DESeq.
```{r}
dds<-DESeq(dds)
```

Let's take a look at our DESeq result.
```{r}
head(dds)
res <- results(dds)
```
Plotting the dispersions, which is done by fitting our data into the curve. Ideally, this would be a hockey stick shape.
```{r}
plotDispEsts(dds, main="Dispersion plot Symbiont Stress")
```
## Pairwise comparision of Cool vs. Control
Here we are starting to look for differentially expressed genes
```{r}
colData$cool<-factor(colData$treat, levels=c("Cool","Control")) #make sure to put treatment first control second
rescool <- results(dds, contrast=c("treat","Cool","Control"))
```
Let’s take a look at the number of genes that meet the different thresholds. padj (p-adjusted) takes in account of the comparasions, rather than just looking at one object like p-value. If we’re looking at a large amount of gene, it’s easy to get a false positive just by chance. We have to do multiple test corrections to get the padj value.
```{r}
###how many FDR < 10%?
table(rescool$padj<0.05)
# 0.1= 7163
# 0.05= 5834
# 0.01= 4057
```
A summary of the number of genes up and down-regulated relative to the control at a p adjusted value of 0.1
```{r}
summary(rescool)
```
There are 6028 samples removed because of low counts. There are 3200 genes down regulated for the cold treatment, and 3963 genes are up regulated with the padj < 0.1

MA plot. *INSERT FIGURE CAPTION*
```{r}
plotMA(rescool, main="Cool vs Control")
plotMA(rescool, main="Cool vs Control", ylim=c(-5,5))
```

